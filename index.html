<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="theme-color" content="#0f1724">
<title>Study Arc V4.0 ‚Äî Ultimate Student Focus</title>
<link rel="icon" href="icons/app-logo-192.png" type="image/png">
<link rel="manifest" href="manifest.json?v=3">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5520401672645952" crossorigin="anonymous"></script>

<style>
/* --- üé® STUDY ARC V4.0 CSS --- */
:root {
  --bg-gradient: linear-gradient(135deg, #0f1724 0%, #071633 100%);
  --glass-bg: rgba(255, 255, 255, 0.05);
  --glass-border: 1px solid rgba(255, 255, 255, 0.1);
  --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
  --backdrop: blur(12px);
  --accent: #38bdf8;
  --accent-grad: linear-gradient(90deg, #38bdf8, #818cf8);
  --text: #ffffff;
  --text-muted: rgba(255, 255, 255, 0.6);
  --danger: #ef4444;
  --success: #10b981;
  --font-main: 'Inter', system-ui, -apple-system, sans-serif;
}

/* Themes */
body.theme-sunset { --bg-gradient: linear-gradient(135deg, #4c1d95, #be185d); --accent: #fbbf24; --accent-grad: linear-gradient(90deg, #fbbf24, #f59e0b); }
body.theme-mint { --bg-gradient: linear-gradient(135deg, #064e3b, #065f46); --accent: #34d399; --accent-grad: linear-gradient(90deg, #34d399, #10b981); }
body.theme-amoled { --bg-gradient: #000000; --glass-bg: rgba(20, 20, 20, 0.9); --glass-border: 1px solid #333; --accent: #ffffff; --accent-grad: linear-gradient(90deg, #ffffff, #999999); --text-muted: #888; }
body.theme-cyber { --bg-gradient: linear-gradient(135deg, #0b0014, #180028); --glass-bg: rgba(255, 0, 200, 0.05); --glass-border: 1px solid rgba(0, 255, 234, 0.3); --accent: #00ffea; --accent-grad: linear-gradient(90deg, #f000ff, #00ffea); --text: #fff; --text-muted: #f000ff; }
body.theme-midnight { --bg-gradient: linear-gradient(135deg, #02111b, #0c2d48); --glass-bg: rgba(100, 150, 255, 0.05); --accent: #5da9e9; --accent-grad: linear-gradient(90deg, #4facfe, #00f2fe); }

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
body { margin: 0; font-family: var(--font-main); background: var(--bg-gradient); color: var(--text); min-height: 100vh; overflow-x: hidden; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

/* Layout Grid */
.app-container { max-width: 1200px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 280px 1fr; gap: 20px; height: 100vh; overflow: hidden; position: relative; }

/* Glass Components */
.glass-panel { background: var(--glass-bg); backdrop-filter: var(--backdrop); -webkit-backdrop-filter: var(--backdrop); border: var(--glass-border); border-radius: 20px; box-shadow: var(--glass-shadow); padding: 20px; overflow-y: auto; }

/* Sidebar & Navigation */
.sidebar { display: flex; flex-direction: column; gap: 15px; height: 100%; z-index: 1000; }
.brand { font-size: 24px; font-weight: 800; background: var(--accent-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; text-align: center; margin-bottom: 10px; }
.nav-item { padding: 12px; border-radius: 12px; cursor: pointer; transition: 0.3s; color: var(--text-muted); display: flex; align-items: center; gap: 10px; font-weight: 500; }
.nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: var(--text); border-left: 4px solid var(--accent); }

/* Challenge Box (Sidebar) */
.challenge-box { padding: 15px; background: rgba(0,0,0,0.3); border-radius: 15px; border: 1px solid var(--glass-border); }
.progress-container { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 10px; overflow: hidden; }
.progress-fill { height: 100%; background: var(--accent-grad); width: 0%; transition: width 0.5s ease; }

/* Main Content Area */
.main-content { display: flex; flex-direction: column; gap: 20px; height: 100%; overflow-y: auto; padding-bottom: 80px; }
.header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; }
.greeting h1 { margin: 0; font-size: 24px; }
.greeting p { margin: 5px 0 0; color: var(--text-muted); font-size: 13px; }

/* Stats & Cards */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
.stat-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
.stat-val { font-size: 24px; font-weight: 800; margin-top: 5px; color: var(--accent); }
.stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

/* Buttons & Inputs */
.btn { border: none; padding: 12px 20px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; font-family: var(--font-main); }
.btn-primary { background: var(--accent-grad); color: #000; box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3); }
.btn-primary:active { transform: scale(0.98); }
.btn-ghost { background: rgba(255,255,255,0.1); color: white; }
.input { width: 100%; padding: 12px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; margin-bottom: 10px; font-family: var(--font-main); }
.input:focus { border-color: var(--accent); }

/* Focus Overlay */
#focusOverlay { position: fixed; inset: 0; background: var(--bg-gradient); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; transform: translateY(100%); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
#focusOverlay.active { transform: translateY(0); }
.timer-huge { font-size: 70px; font-weight: 900; font-variant-numeric: tabular-nums; background: var(--accent-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

/* Modals */
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 6000; display: flex; align-items: center; justify-content: center; }
.hidden { display: none !important; }

/* Exam Guide */
.guide-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; margin-bottom: 15px; overflow: hidden; }
.guide-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: rgba(255,255,255,0.02); }
.guide-content { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; color: var(--text-muted); font-size: 14px; line-height: 1.6; }
.guide-content.open { padding: 15px; max-height: 1000px; border-top: 1px solid rgba(255,255,255,0.1); }

/* Math Toolbar */
.math-toolbar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; }
.math-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 5px 12px; border-radius: 8px; cursor: pointer; min-width: 40px; }

/* Ads Area */
.ad-slot { width: 100%; text-align: center; margin: 10px 0; background: rgba(0,0,0,0.2); border-radius: 12px; overflow: hidden; min-height: 60px; display:flex; justify-content:center; align-items:center; }
.ad-label { font-size: 9px; color: #666; text-transform: uppercase; margin-bottom: 2px; display:block; }

/* üì± MOBILE FIXES (V4.0) */
.mobile-header { display: none; justify-content: space-between; align-items: center; padding-bottom: 15px; }
.hamburger { font-size: 24px; cursor: pointer; background: none; border: none; color: white; }
.overlay-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 999; display: none; backdrop-filter: blur(3px); }

@media (max-width: 768px) {
  .app-container { grid-template-columns: 1fr; padding: 15px; height: 100vh; overflow-y: auto; display: block; }
  
  /* Sidebar Floating Drawer Logic */
  .sidebar { 
      position: fixed; top: 0; left: -300px; width: 280px; height: 100%; 
      background: var(--bg-gradient); border-right: 1px solid var(--glass-border); 
      transition: left 0.3s ease; box-shadow: 10px 0 30px rgba(0,0,0,0.5); 
      z-index: 2000; padding: 20px; 
  }
  .sidebar.active { left: 0; }
  .overlay-bg.active { display: block; }
  
  /* Show Mobile Header */
  .mobile-header { display: flex; }
  .main-content { height: auto; overflow: visible; padding-bottom: 100px; }
  .timer-huge { font-size: 55px; }
}
</style>
</head>
<body class="theme-mint">

<canvas id="confetti-canvas" style="position:fixed; pointer-events:none; top:0; left:0; width:100%; height:100%; z-index:100;"></canvas>

<div id="mobileOverlay" class="overlay-bg" onclick="toggleSidebar()"></div>

<div id="onboardingModal" class="modal hidden">
  <div class="glass-panel" style="max-width: 350px; text-align: center; border: 2px solid var(--accent);">
    <div style="font-size: 40px; margin-bottom: 10px;">üöÄ</div>
    <h2>Welcome to Study Arc</h2>
    <p style="color:var(--text-muted); font-size:14px; margin-bottom:20px;">Let's personalize your success journey.</p>
    <input id="obName" class="input" placeholder="Your Name (e.g., Abhinav)">
    <input id="obClass" class="input" placeholder="Target Exam (e.g., NEET 2027)">
    <button class="btn btn-primary" style="width: 100%;" onclick="completeOnboarding()">Start Journey</button>
  </div>
</div>

<div id="focusOverlay">
  <div style="font-size: 16px; letter-spacing: 2px; text-transform: uppercase; color: var(--accent); margin-bottom: 20px;" id="focusSubjectDisplay">PHYSICS</div>
  <div class="timer-huge" id="focusTimerDisplay">00:00:00</div>
  <div style="margin-top: 20px; color: var(--text-muted); font-style: italic; text-align:center; padding:0 20px;">"Pain is temporary. Glory is forever."</div>
  <div style="display: flex; gap: 20px; margin-top: 40px;">
    <button id="btnPause" class="btn btn-ghost" style="border:1px solid white;" onclick="toggleTimer()">‚è∏Ô∏è Pause</button>
    <button class="btn" style="background: var(--danger); color: white;" onclick="exitFocus()">Stop Session</button>
  </div>
  <div style="margin-top: 20px; font-size: 10px; opacity: 0.5;">SCREEN WAKE LOCK ACTIVE üí°</div>
</div>

<div class="app-container">
  
  <div class="mobile-header">
      <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
      <div class="brand" style="font-size: 20px; margin:0;">STUDY ARC</div>
      <div style="width: 24px;"></div> </div>

  <aside class="sidebar glass-panel" id="sidebarMenu">
    <div class="brand">STUDY ARC</div>
    
    <div class="challenge-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:11px; font-weight:bold; color:var(--accent);">CURRENT CHALLENGE</span>
            <span id="challengeStatus" style="font-size:10px;">Active</span>
        </div>
        <div id="challengeText" style="font-size:16px; font-weight:800; margin-top:5px;">Set Goal üëá</div>
        <div class="progress-container">
            <div id="challengeBar" class="progress-fill" style="width: 0%;"></div>
        </div>
        <div style="font-size:10px; margin-top:5px; text-align:right; opacity:0.7;">
            Day <span id="challengeDay">0</span> / <span id="challengeTarget">0</span>
        </div>
    </div>

    <nav style="display: flex; flex-direction: column; gap: 8px; margin-top:10px;">
      <div class="nav-item active" onclick="showSection('dashboard')">üìä Dashboard</div>
      <div class="nav-item" onclick="showSection('challenges')">üèÜ Challenges (New)</div>
      <div class="nav-item" onclick="showSection('guide')">‚ÑπÔ∏è Exam Guide</div>
      <div class="nav-item" onclick="showSection('planner')">ü§ñ AI Planner</div>
      <div class="nav-item" onclick="showSection('notes')">üìù Scratchpad</div>
      <div class="nav-item" onclick="showSection('settings')">‚öôÔ∏è Settings</div>
    </nav>
    
    <div style="margin-top: auto;">
      <div class="community-widget">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:5px;">
          <div style="width:8px; height:8px; background:#10b981; border-radius:50%;"></div>
          <strong style="color:#10b981">LIVE NOW</strong>
        </div>
        <span id="liveUsers">1,240</span> students focusing.
      </div>
      
      <div class="ad-slot">
          <span class="ad-label">Sponsored</span>
          <ins class="adsbygoogle"
               style="display:block"
               data-ad-client="ca-pub-5520401672645952"
               data-ad-slot="9706016855"
               data-ad-format="auto"
               data-full-width-responsive="true"></ins>
          <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      </div>
    </div>
  </aside>

  <main class="main-content">
    
    <div id="section-dashboard">
      <div class="header">
        <div class="greeting">
          <h1 id="userGreet">Hello, Student</h1>
          <p id="dateDisplay">Let's crush your goals today!</p>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <div class="glass-panel" style="padding: 10px 15px; min-width: 120px; text-align: center; border: 1px solid var(--accent);">
                <div id="rankDisplay" style="font-weight:bold;">üå± Beginner</div>
                <div style="font-size:10px; opacity:0.7;">Lifetime Streak</div>
            </div>
            <button id="btnClaim" class="btn" style="background:var(--success); padding:10px 15px; display:none;" onclick="openClaimModal()">
                üèÜ Claim
            </button>
        </div>
      </div>

      <div class="ad-slot">
          <span class="ad-label">Sponsored</span>
          <ins class="adsbygoogle"
               style="display:block"
               data-ad-client="ca-pub-5520401672645952"
               data-ad-slot="2938617898"
               data-ad-format="auto"
               data-full-width-responsive="true"></ins>
          <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      </div>

      <div class="glass-panel" style="margin-bottom: 20px; border: 1px solid var(--accent);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <h3 style="margin:0;">‚ö° Quick Focus</h3>
        </div>
        <div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr auto; gap: 8px; align-items: center;">
            <select id="quickSubject" class="input" style="margin:0;">
                <option value="Physics">Physics</option>
                <option value="Chemistry">Chemistry</option>
                <option value="Biology">Biology</option>
                <option value="Maths">Maths</option>
            </select>
            <input id="quickHrs" type="number" class="input" placeholder="Hr" value="0" style="margin:0;">
            <input id="quickMins" type="number" class="input" placeholder="Min" value="45" style="margin:0;">
            <button class="btn btn-primary" style="padding: 12px;" onclick="startQuickFocus()">‚ñ∂</button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Studied Today</div>
          <div class="stat-val" id="todayTime">0h 0m</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Focus</div>
          <div class="stat-val" id="totalFocusTime">0h</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Subject Analysis</div>
          <div style="height: 100px; margin-top: 5px;">
            <canvas id="subjectChart"></canvas>
          </div>
        </div>
      </div>

      <div class="glass-panel" style="margin-top: 20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
          <h3>‚úÖ Tasks</h3>
          <button class="btn btn-ghost" style="font-size:12px;" onclick="toggleTaskForm()">+ Add</button>
        </div>
        
        <div id="addTaskForm" style="display:none; margin-bottom:15px; background:rgba(0,0,0,0.2); padding:10px; border-radius:10px;">
          <input id="newTaskName" class="input" placeholder="Task Name (e.g., Physics Ch 1)">
          <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" onclick="addTask()">Add Task</button>
          </div>
        </div>

        <div id="taskListContainer"></div>
      </div>
    </div>

    <div id="section-challenges" class="hidden">
      <div class="glass-panel">
        <h2>üèÜ Challenge Mode</h2>
        <p style="color:var(--text-muted); margin-bottom:20px;">Push your limits. 75 Hard or Custom.</p>
        
        <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:15px; border:1px solid var(--glass-border);">
            <label>Start New Challenge</label>
            <input id="challengeNameInput" class="input" placeholder="Challenge Name (e.g. 75 Hard)" style="margin-top:10px;">
            <div style="display:flex; gap:10px;">
                <select id="challengeDaysInput" class="input">
                    <option value="30">30 Days</option>
                    <option value="50">50 Days</option>
                    <option value="75">75 Hard</option>
                    <option value="100">100 Days</option>
                </select>
                <button class="btn btn-primary" onclick="startChallenge()">Start üî•</button>
            </div>
            <p style="font-size:12px; color:var(--danger); margin-top:10px;">‚ö†Ô∏è Starting a new challenge will reset your current progress!</p>
        </div>
      </div>
    </div>

    <div id="section-guide" class="hidden">
      <div class="glass-panel">
        <h2>‚ÑπÔ∏è Exam Success Hub</h2>
        <p style="color:var(--text-muted); margin-bottom:20px;">Strategy, Hacks & Resources.</p>
        
        <div class="guide-card">
            <div class="guide-header" onclick="toggleGuide(this)"><strong>ü©∫ NEET Strategy</strong><span>‚ñº</span></div>
            <div class="guide-content">
                <h4 style="color:var(--accent); margin-top:0;">Target 680+</h4>
                <ul><li><strong>Bio:</strong> NCERT Only.</li><li><strong>Physics:</strong> Practice Questions > Theory.</li></ul>
            </div>
        </div>
        <div class="guide-card">
            <div class="guide-header" onclick="toggleGuide(this)"><strong>üë∑ JEE Roadmap</strong><span>‚ñº</span></div>
            <div class="guide-content">
                <h4 style="color:var(--accent); margin-top:0;">Engineering Excellence</h4>
                <ul><li><strong>Maths:</strong> Calculus is key.</li><li><strong>Chem:</strong> Inorganic from NCERT.</li></ul>
            </div>
        </div>
      </div>
    </div>

    <div id="section-planner" class="hidden">
      <div class="glass-panel">
        <h2>ü§ñ AI Planner</h2>
        <textarea id="aiSyllabus" class="input" rows="5" placeholder="Chapters (separated by comma)..."></textarea>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
          <input type="date" id="aiDate" class="input">
          <button class="btn btn-primary" onclick="generatePlan()">Generate</button>
        </div>
        <div id="aiResult" style="margin-top:20px;"></div>
        <div class="ad-slot">
             <span class="ad-label">Sponsored</span>
             <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5520401672645952" data-ad-slot="4459868531" data-ad-format="auto" data-full-width-responsive="true"></ins>
             <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>
      </div>
    </div>

    <div id="section-notes" class="hidden">
      <div class="glass-panel" style="height:100%; display:flex; flex-direction:column;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <h2>üìù Notes</h2>
          <button class="btn btn-ghost" onclick="downloadNotes()">üíæ</button>
        </div>
        <div class="math-toolbar">
            <button class="math-btn" onclick="insSym('‚àö')">‚àö</button><button class="math-btn" onclick="insSym('Œ∏')">Œ∏</button><button class="math-btn" onclick="insSym('œÄ')">œÄ</button><button class="math-btn" onclick="insSym('¬≤')">x¬≤</button><button class="math-btn" onclick="insSym('Œî')">Œî</button>
        </div>
        <textarea id="scratchpad" class="input" style="flex:1; resize:none; font-family:monospace; font-size:16px;" placeholder="Type here..."></textarea>
      </div>
    </div>

    <div id="section-settings" class="hidden">
      <div class="glass-panel">
        <h2>‚öôÔ∏è Settings</h2>
        
        <div style="margin-top:20px;">
           <label>Profile</label>
           <div style="display:flex; gap:10px; margin-top:5px;">
               <input id="editName" class="input" placeholder="Name">
               <input id="editExam" class="input" placeholder="Exam">
           </div>
           <button class="btn btn-ghost" style="width:100%; border:1px solid var(--accent);" onclick="updateProfile()">Update Profile</button>
        </div>

        <div style="margin-top:15px;">
            <label>Backup Data</label>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" style="flex:1;" onclick="exportData()">Export</button>
                <button class="btn btn-ghost" style="flex:1; border:1px solid var(--accent);" onclick="document.getElementById('importFile').click()">Import</button>
                <input type="file" id="importFile" style="display:none;" onchange="importData(this)">
            </div>
        </div>

        <div style="margin-top:15px;">
            <label>Theme</label>
            <select id="themeSelect" class="input" onchange="changeTheme(this.value)">
                <option value="mint">Mint Fresh</option>
                <option value="sunset">Sunset Vibes</option>
                <option value="amoled">Pitch Black (AMOLED)</option>
                <option value="cyber">Cyberpunk Neon</option>
                <option value="midnight">Midnight Blue</option>
            </select>
            <button class="btn" style="background:var(--danger); color:white; width:100%; margin-top:20px;" onclick="hardReset()">‚ö†Ô∏è Reset App</button>
        </div>
      </div>
    </div>

  </main>
</div>

<div id="claimModal" class="modal hidden">
  <div class="glass-panel" style="max-width: 350px; text-align: center; border: 2px solid var(--accent);">
    <div style="font-size:40px;">ü¶Å</div>
    <h2>Hey Champ!</h2>
    <p>Did you complete your goals today? <br><span style="color:var(--danger); font-size:12px;">Honesty is Key.</span></p>
    <div style="display:flex; gap:10px; justify-content:center;">
        <button class="btn btn-ghost" onclick="document.getElementById('claimModal').classList.add('hidden')">‚ùå No</button>
        <button class="btn btn-primary" onclick="confirmClaim()">‚úÖ YES!</button>
    </div>
  </div>
</div>

<script>
/* --- üß† CORE LOGIC V4.0 (Fixed & Enhanced) --- */

let profile = JSON.parse(localStorage.getItem('st_profile'));
let tasks = JSON.parse(localStorage.getItem('st_tasks') || '[]');
let streak = parseInt(localStorage.getItem('st_streak') || '0');
let history = JSON.parse(localStorage.getItem('st_history') || '{}');
let notes = localStorage.getItem('st_notes') || '';
let theme = localStorage.getItem('st_theme') || 'mint';
let challenge = JSON.parse(localStorage.getItem('st_challenge') || '{"active":false, "name":"None", "target":0, "day":1, "lastClaim":0, "status":"active"}');

// Timer Globals
let timerInterval, endTime, currentSubject, wakeLock;
let isPaused = false, timeRemaining = 0, sessionDuration = 0;

function init() {
  if(!profile) {
    document.getElementById('onboardingModal').classList.remove('hidden');
  } else {
    checkChallengeStatus();
    updateUI();
  }
  document.body.className = `theme-${theme}`;
  document.getElementById('themeSelect').value = theme;
  document.getElementById('scratchpad').value = notes;
  document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('en-IN', { weekday: 'long', month: 'long', day: 'numeric' });
  renderTasks(); renderChart();
}

// üì± Mobile Sidebar Logic
function toggleSidebar() {
    const sb = document.getElementById('sidebarMenu');
    const ov = document.getElementById('mobileOverlay');
    sb.classList.toggle('active');
    ov.classList.toggle('active');
}
// Close sidebar when clicking menu item on mobile
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
        if(window.innerWidth <= 768) toggleSidebar();
    });
});

function completeOnboarding() {
    const n = document.getElementById('obName').value;
    const e = document.getElementById('obClass').value;
    if(!n) { alert("Please enter your name!"); return; } // Validation Added
    profile = { name: n, exam: e };
    localStorage.setItem('st_profile', JSON.stringify(profile));
    document.getElementById('onboardingModal').classList.add('hidden');
    updateUI();
}

function updateUI() {
    if(profile) {
        document.getElementById('userGreet').innerText = `Hello, ${profile.name}`;
        document.getElementById('editName').value = profile.name;
        document.getElementById('editExam').value = profile.exam;
    }
    // Ranks
    let rank="Beginner";
    if(streak>=7) rank="üî• Spark"; if(streak>=21) rank="ü¶Å Beast"; if(streak>=50) rank="üëë GOD";
    document.getElementById('rankDisplay').innerHTML = `<div style="font-weight:bold;color:var(--accent);">${rank}</div><div style="font-size:10px;">${streak} Day Streak</div>`;

    // Challenge Box
    const cBox = document.querySelector('.challenge-box');
    if(!challenge.active) {
        cBox.style.display = 'none';
    } else {
        cBox.style.display = 'block';
        document.getElementById('challengeText').innerText = challenge.name;
        document.getElementById('challengeDay').innerText = challenge.day;
        document.getElementById('challengeTarget').innerText = challenge.target;
        document.getElementById('challengeBar').style.width = `${(challenge.day/challenge.target)*100}%`;
        
        // Claim Button Visibility
        const last = new Date(challenge.lastClaim).toDateString();
        const today = new Date().toDateString();
        const btn = document.getElementById('btnClaim');
        if(challenge.status !== 'failed' && last !== today) btn.style.display = 'block';
        else btn.style.display = 'none';
    }
    
    // Today Time
    let todaySecs = 0; // Needs real daily tracking logic, keeping simple for now
    let totalSecs = Object.values(history).reduce((a,b)=>a+b, 0);
    document.getElementById('totalFocusTime').innerText = `${(totalSecs/3600).toFixed(1)}h`;
}

// üî• Challenge Logic
function startChallenge() {
    const name = document.getElementById('challengeNameInput').value || "Hard Challenge";
    const days = document.getElementById('challengeDaysInput').value;
    if(confirm(`Start ${days} days "${name}"? Previous progress will reset.`)) {
        challenge = { active: true, name: name, target: parseInt(days), day: 1, lastClaim: 0, status: "active" };
        localStorage.setItem('st_challenge', JSON.stringify(challenge));
        alert("Challenge Started! üöÄ");
        updateUI();
    }
}
function checkChallengeStatus() {
    if(!challenge.active || challenge.lastClaim === 0) return;
    const diff = Math.floor((new Date() - new Date(challenge.lastClaim)) / (1000*60*60*24));
    if(diff > 1) { // Missed more than 1 day
        challenge.status = "failed"; 
        alert("‚ùå Challenge Failed! You missed a day.");
        // Reset or Keep failed state
    }
    localStorage.setItem('st_challenge', JSON.stringify(challenge));
}
function openClaimModal() { document.getElementById('claimModal').classList.remove('hidden'); }
function confirmClaim() {
    streak++; localStorage.setItem('st_streak', streak);
    if(challenge.active) {
        challenge.day++;
        challenge.lastClaim = Date.now();
        if(challenge.day > challenge.target) { alert("üèÜ CHALLENGE COMPLETED!"); challenge.active = false; }
        localStorage.setItem('st_challenge', JSON.stringify(challenge));
    }
    document.getElementById('claimModal').classList.add('hidden');
    if(window.confetti) confetti({particleCount:100, spread:70, origin:{y:0.6}});
    updateUI();
}

// ‚ö° Timer Logic (Fixed)
function startQuickFocus() {
    const h = parseInt(document.getElementById('quickHrs').value)||0;
    const m = parseInt(document.getElementById('quickMins').value)||0;
    if(h===0 && m===0) return alert("Set time!");
    
    currentSubject = document.getElementById('quickSubject').value;
    sessionDuration = (h*3600) + (m*60); // Store intended duration
    timeRemaining = sessionDuration;
    isPaused = false;
    
    document.getElementById('focusOverlay').classList.add('active');
    document.getElementById('focusSubjectDisplay').innerText = currentSubject;
    try { wakeLock = navigator.wakeLock.request('screen'); } catch(e){}
    runTimer();
}
function runTimer() {
    clearInterval(timerInterval);
    endTime = Date.now() + (timeRemaining * 1000);
    updateDisplay();
    timerInterval = setInterval(() => {
        if(isPaused) return;
        const diff = Math.ceil((endTime - Date.now())/1000);
        if(diff <= 0) finishFocus();
        else { timeRemaining = diff; updateDisplay(); }
    }, 1000);
}
function updateDisplay() {
    const h = Math.floor(timeRemaining/3600).toString().padStart(2,'0');
    const m = Math.floor((timeRemaining%3600)/60).toString().padStart(2,'0');
    const s = (timeRemaining%60).toString().padStart(2,'0');
    document.getElementById('focusTimerDisplay').innerText = `${h}:${m}:${s}`;
}
function toggleTimer() {
    isPaused = !isPaused;
    if(isPaused) { clearInterval(timerInterval); document.getElementById('btnPause').innerText = "‚ñ∂ Resume"; }
    else { runTimer(); document.getElementById('btnPause').innerText = "‚è∏ Pause"; }
}
function finishFocus() {
    clearInterval(timerInterval);
    const audio = new AudioContext(); 
    const osc = audio.createOscillator(); osc.connect(audio.destination); osc.start(); osc.stop(audio.currentTime+0.5);
    alert("Session Complete! üéâ");
    exitFocus();
}
function exitFocus() {
    clearInterval(timerInterval); if(wakeLock) wakeLock.release();
    document.getElementById('focusOverlay').classList.remove('active');
    // Add ACTUAL time spent (Session Duration)
    if(!history[currentSubject]) history[currentSubject]=0; 
    history[currentSubject] += sessionDuration; 
    localStorage.setItem('st_history', JSON.stringify(history));
    updateUI(); renderChart();
}

// ü§ñ AI Planner Logic (Maths)
function generatePlan() {
    const txt = document.getElementById('aiSyllabus').value;
    const date = document.getElementById('aiDate').value;
    if(!txt || !date) return alert("Fill details!");
    
    const chapters = txt.split(',').filter(x=>x.trim()!=='');
    const days = Math.ceil((new Date(date) - new Date())/(1000*60*60*24));
    
    if(days <= 0) return alert("Date must be future!");
    const rate = (chapters.length/days).toFixed(1);
    
    document.getElementById('aiResult').innerHTML = `
    <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:10px;">
        <h3>Strategy: ${rate} Ch/Day</h3>
        <p>Total ${chapters.length} Chapters in ${days} Days.</p>
    </div>`;
}

// Utils
function showSection(id) {
    if(window.innerWidth <= 768) {
        document.getElementById('sidebarMenu').classList.remove('active');
        document.getElementById('mobileOverlay').classList.remove('active');
    }
    document.querySelectorAll('[id^="section-"]').forEach(d=>d.classList.add('hidden'));
    document.getElementById(`section-${id}`).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
}
function exportData() {
    const d = {profile, tasks, history, notes, settings, streak, challenge};
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(d)], {type:'application/json'}));
    a.download = 'study_backup.json'; a.click();
}
function importData(inp) {
    const r = new FileReader();
    r.onload = e => {
        try {
            const d = JSON.parse(e.target.result);
            localStorage.setItem('st_profile', JSON.stringify(d.profile));
            localStorage.setItem('st_history', JSON.stringify(d.history));
            localStorage.setItem('st_challenge', JSON.stringify(d.challenge));
            alert("Success! Reloading."); location.reload();
        } catch(e) { alert("Bad File"); }
    };
    if(inp.files[0]) r.readAsText(inp.files[0]);
}
function updateProfile() {
    const n = document.getElementById('editName').value;
    if(n) { profile.name = n; profile.exam = document.getElementById('editExam').value; localStorage.setItem('st_profile', JSON.stringify(profile)); updateUI(); alert("Saved!"); }
}
function changeTheme(v) { localStorage.setItem('st_theme', v); document.body.className=`theme-${v}`; }
function hardReset() { if(confirm("Reset All?")) { localStorage.clear(); location.reload(); } }
function toggleGuide(e) { e.nextElementSibling.classList.toggle('open'); }
function downloadNotes() { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([document.getElementById('scratchpad').value])); a.download='notes.txt'; a.click(); }
function insSym(s) { const p=document.getElementById('scratchpad'); p.value+=s; localStorage.setItem('st_notes', p.value); }
document.getElementById('scratchpad').addEventListener('input', e=>localStorage.setItem('st_notes', e.target.value));

// Tasks
function addTask() { const n=document.getElementById('newTaskName').value; if(n) { tasks.unshift({id:Date.now(), name:n, done:false}); renderTasks(); document.getElementById('newTaskName').value=''; } }
function renderTasks() { 
    localStorage.setItem('st_tasks', JSON.stringify(tasks));
    document.getElementById('taskListContainer').innerHTML = tasks.map(t=>`
    <div class="task-item" style="opacity:${t.done?0.5:1}">
       <span style="${t.done?'text-decoration:line-through':''}">${t.name}</span>
       <div><button onclick="toggleTask(${t.id})">‚úîÔ∏è</button><button onclick="delTask(${t.id})">‚úñ</button></div>
    </div>`).join('');
}
function toggleTask(id) { const t=tasks.find(x=>x.id===id); t.done=!t.done; renderTasks(); }
function delTask(id) { tasks=tasks.filter(x=>x.id!==id); renderTasks(); }
function toggleTaskForm() { const f=document.getElementById('addTaskForm'); f.style.display=f.style.display==='none'?'block':'none'; }

function renderChart() {
    const ctx = document.getElementById('subjectChart').getContext('2d');
    const d = Object.values(history).map(s=>(s/3600).toFixed(1));
    if(window.myChart) window.myChart.destroy();
    window.myChart = new Chart(ctx, {type:'doughnut', data:{labels:Object.keys(history), datasets:[{data:d.length?d:[1], backgroundColor:['#34d399','#38bdf8','#fbbf24']}]}, options:{plugins:{legend:{display:false}}, responsive:true, maintainAspectRatio:false}});
}

init();
if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
</script>
</body>
</html>